name: Deploy to Azure Blob Storage

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.2.2
      with:
        submodules: 'true'
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    - run: npm ci
    - run: npm run build --if-present
    - uses: Azure/login@v2.3.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    - name: Upload to blob storage
      uses: Azure/cli@v2.1.0
      with:
        inlineScript: |
          az storage blob upload-batch --account-name ${{ vars.STORAGE_ACCOUNT_NAME }} --auth-mode login -d '$web' -s public
#    - name: Purge CDN endpoint
#      uses: Azure/cli@v2.1.0
#      with:
#        inlineScript: |
#          az cdn endpoint purge --content-paths  "/*" --profile-name "${{ vars.CDN_PROFILE_NAME }}" --name "${{ vars.CDN_ENDPOINT }}" --resource-group "${{ vars.RESOURCE_GROUP }}"
    - name: Logout
      run: |
        az logout
      if: always()
